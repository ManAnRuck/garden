kind: ConfigTemplate
name: k8s-container
inputsSchemaPath: schema.json

configs:
  - kind: Build
    type: container
    name: ${parent.name}
    description: ${parent.name} image

  - kind: Deploy
    type: kubernetes
    name: ${parent.name}
    description: ${parent.name} manifests

    dependencies:
      - build.${parent.name}

    spec:
      files: 
      - ../template/manifests/* # how i understood this
      # - ${local.projectPath}/manifests/* # and this should work but throws an error

      patchResources:
        - kind: Service
          name: my-service
          patch:
            metadata:
              name: ${parent.name}
              labels:
                service: ${parent.name}
            spec:
              ports:
                - name: http
                  port: ${inputs.servicePort}
              selector:
                service: ${parent.name}

      manifests:
        - apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${parent.name}
            labels:
              service: ${parent.name}
          spec:
            replicas: ${inputs.replicas || 3}
            selector:
              matchLabels:
                service: ${parent.name}
            template:
              metadata:
                labels:
                  service: ${parent.name}
              spec:
                containers:
                  - name: main
                    image: ${actions.build["${parent.name}"].outputs.deployment-image-id}
                    ports:
                      - name: http
                        containerPort: ${inputs.containerPort}
